<!-- MJ Chatbot Widget - Ghost Pro Version (No Template Literals) -->
<!-- Paste this entire code block into Ghost Admin → Settings → Code Injection → Site Footer -->

<style>
  #ghost-portal-root { bottom: 120px !important; }
</style>

<script>
(function() {
  'use strict';

  var CONFIG = {
    apiEndpoint: 'https://mj-chatbot-backend.mejones73.workers.dev/chat',
    rateLimitCooldown: 60000
  };

  var state = {
    isOpen: false,
    messages: [],
    sessionId: localStorage.getItem('mj-chatbot-session') || generateSessionId(),
    isLoading: false,
    rateLimited: false,
    rateLimitEnd: null
  };

  function generateSessionId() {
    var id = 'sess_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    localStorage.setItem('mj-chatbot-session', id);
    return id;
  }

  function escapeHtml(text) {
    var div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function injectStyles() {
    var css = '';
    css += '.mj-chatbot-widget { position: fixed; bottom: 20px; right: 20px; z-index: 2147483647; ';
    css += 'font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; ';
    css += 'display: flex; align-items: center; gap: 12px; }';

    css += '.mj-chatbot-label { background: white; color: #2563eb; padding: 10px 16px; ';
    css += 'border-radius: 20px; font-size: 14px; font-weight: 600; ';
    css += 'box-shadow: 0 2px 8px rgba(0,0,0,0.1); white-space: nowrap; opacity: 0; ';
    css += 'animation: labelSlideIn 0.4s ease-out 0.5s forwards; }';

    css += '@keyframes labelSlideIn { from { opacity: 0; transform: translateX(10px); } ';
    css += 'to { opacity: 1; transform: translateX(0); } }';

    css += '.mj-chatbot-bubble { width: 60px; height: 60px; border-radius: 50%; ';
    css += 'background: #2563eb; border: none; color: white; cursor: pointer; ';
    css += 'box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; align-items: center; ';
    css += 'justify-content: center; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }';

    css += '.mj-chatbot-bubble:hover { background: #1e40af; ';
    css += 'box-shadow: 0 6px 16px rgba(0,0,0,0.2); transform: scale(1.05); }';

    css += '.mj-chatbot-bubble:active { transform: scale(0.95); }';

    css += '.mj-chatbot-window { width: 400px; height: 600px; background: white; ';
    css += 'border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.15); ';
    css += 'display: flex; flex-direction: column; ';
    css += 'animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1); }';

    css += '@keyframes slideUp { from { opacity: 0; transform: translateY(20px) scale(0.95); } ';
    css += 'to { opacity: 1; transform: translateY(0) scale(1); } }';

    css += '.mj-chatbot-header { background: #2563eb; color: white; padding: 16px; ';
    css += 'border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center; }';

    css += '.mj-chatbot-header-title { font-size: 16px; font-weight: 600; }';
    css += '.mj-chatbot-header-buttons { display: flex; gap: 8px; }';

    css += '.mj-chatbot-header-button { background: none; border: none; color: white; ';
    css += 'cursor: pointer; padding: 8px; width: 44px; height: 44px; border-radius: 6px; ';
    css += 'transition: background 0.2s; display: flex; align-items: center; justify-content: center; }';

    css += '.mj-chatbot-header-button:hover { background: rgba(255,255,255,0.1); }';

    css += '.mj-chatbot-messages { flex: 1; overflow-y: auto; padding: 16px; ';
    css += 'display: flex; flex-direction: column; gap: 12px; }';

    css += '.mj-chatbot-message { max-width: 80%; padding: 10px 14px; border-radius: 12px; ';
    css += 'animation: messageAppear 0.3s ease-out; }';

    css += '@keyframes messageAppear { from { opacity: 0; transform: translateY(10px); } ';
    css += 'to { opacity: 1; transform: translateY(0); } }';

    css += '.mj-chatbot-message-user { background: #2563eb; color: white; align-self: flex-end; }';
    css += '.mj-chatbot-message-assistant { background: #f3f4f6; color: #374151; align-self: flex-start; }';

    css += '.mj-chatbot-suggestions { display: flex; flex-wrap: wrap; gap: 8px; padding: 0 16px 16px; }';

    css += '.mj-chatbot-suggestion { background: white; border: 1px solid #e5e7eb; ';
    css += 'border-radius: 8px; padding: 14px 16px; cursor: pointer; font-size: 14px; color: #374151; ';
    css += 'transition: all 0.2s; min-height: 44px; display: flex; align-items: center; }';

    css += '.mj-chatbot-suggestion:hover { background: #f3f4f6; border-color: #2563eb; color: #2563eb; }';
    css += '.mj-chatbot-suggestion:active { transform: scale(0.98); }';

    css += '.mj-chatbot-input-container { padding: 16px; border-top: 1px solid #e5e7eb; ';
    css += 'display: flex; gap: 8px; }';

    css += '.mj-chatbot-input { flex: 1; border: 1px solid #e5e7eb; border-radius: 8px; ';
    css += 'padding: 10px 12px; font-size: 14px; font-family: inherit; resize: none; ';
    css += 'min-height: 44px; max-height: 120px; }';

    css += '.mj-chatbot-input:focus { outline: 2px solid #2563eb; outline-offset: -1px; }';

    css += '.mj-chatbot-send-button { background: #2563eb; border: none; border-radius: 6px; ';
    css += 'color: white; padding: 10px 20px; font-size: 14px; font-weight: 600; cursor: pointer; ';
    css += 'min-width: 80px; min-height: 44px; transition: all 0.2s; }';

    css += '.mj-chatbot-send-button:hover:not(:disabled) { background: #1e40af; }';
    css += '.mj-chatbot-send-button:active:not(:disabled) { transform: scale(0.98); }';
    css += '.mj-chatbot-send-button:disabled { background: #9ca3af; cursor: not-allowed; opacity: 0.6; }';

    css += '.mj-chatbot-typing { display: flex; gap: 4px; align-self: flex-start; ';
    css += 'padding: 10px 14px; background: #f3f4f6; border-radius: 12px; }';

    css += '.mj-chatbot-typing-dot { width: 8px; height: 8px; border-radius: 50%; ';
    css += 'background: #9ca3af; animation: typingBounce 1.4s infinite; }';

    css += '.mj-chatbot-typing-dot:nth-child(2) { animation-delay: 0.2s; }';
    css += '.mj-chatbot-typing-dot:nth-child(3) { animation-delay: 0.4s; }';

    css += '@keyframes typingBounce { 0%, 60%, 100% { transform: translateY(0); } ';
    css += '30% { transform: translateY(-8px); } }';

    css += '.mj-chatbot-rate-limit { background: #fef3c7; color: #92400e; ';
    css += 'padding: 12px 16px; margin: 0 16px 16px; border-radius: 8px; ';
    css += 'font-size: 14px; text-align: center; }';

    css += '@media (max-width: 768px) {';
    css += '.mj-chatbot-widget { flex-direction: column-reverse; align-items: flex-end; gap: 8px; }';
    css += '.mj-chatbot-label { font-size: 12px; padding: 8px 12px; }';
    css += '.mj-chatbot-window { width: 100vw; height: 100dvh; height: 100vh; ';
    css += 'border-radius: 0; bottom: 0; right: 0; }';
    css += '.mj-chatbot-header { border-radius: 0; }';
    css += '}';

    var style = document.createElement('style');
    style.textContent = css;
    document.head.appendChild(style);
  }

  function createBubbleView() {
    var container = document.createElement('div');
    container.className = 'mj-chatbot-widget';
    container.setAttribute('lang', 'en');

    var label = document.createElement('div');
    label.className = 'mj-chatbot-label';
    label.textContent = 'AI Assistant';

    var bubble = document.createElement('button');
    bubble.className = 'mj-chatbot-bubble';
    bubble.setAttribute('aria-label', 'Open AI assistant to ask questions about Mike Jones');
    bubble.setAttribute('role', 'button');
    bubble.innerHTML = '<svg width="28" height="28" viewBox="0 0 24 24" fill="white"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>';

    container.appendChild(label);
    container.appendChild(bubble);

    return container;
  }

  function createWindowView() {
    var container = document.createElement('div');
    container.className = 'mj-chatbot-widget';

    var window = document.createElement('div');
    window.className = 'mj-chatbot-window';
    window.setAttribute('role', 'dialog');
    window.setAttribute('aria-label', 'AI Assistant for Mike Jones');
    window.setAttribute('aria-modal', 'true');

    var header = document.createElement('div');
    header.className = 'mj-chatbot-header';
    header.innerHTML = '<div class="mj-chatbot-header-title">AI Assistant</div>' +
      '<div class="mj-chatbot-header-buttons">' +
      '<button class="mj-chatbot-header-button mj-chatbot-minimize" aria-label="Minimize chat">' +
      '<svg width="20" height="20" viewBox="0 0 24 24" fill="white">' +
      '<path d="M19 13H5v-2h14v2z"/></svg></button>' +
      '<button class="mj-chatbot-header-button mj-chatbot-close" aria-label="Close chat">' +
      '<svg width="20" height="20" viewBox="0 0 24 24" fill="white">' +
      '<path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>' +
      '</svg></button></div>';

    var messages = document.createElement('div');
    messages.className = 'mj-chatbot-messages';
    messages.setAttribute('role', 'log');
    messages.setAttribute('aria-live', 'polite');
    messages.setAttribute('aria-label', 'Conversation messages');

    if (state.messages.length === 0) {
      var greeting = document.createElement('div');
      greeting.className = 'mj-chatbot-message mj-chatbot-message-assistant';
      greeting.textContent = "Hi! I'm an AI assistant here to answer questions about Mike Jones' work, experience, and projects. Ask me about his 29 years in tech, AI implementation expertise, consulting services, or published content. What would you like to know?";
      messages.appendChild(greeting);
    } else {
      state.messages.forEach(function(msg) {
        var msgDiv = document.createElement('div');
        msgDiv.className = 'mj-chatbot-message mj-chatbot-message-' + msg.role;
        msgDiv.innerHTML = escapeHtml(msg.content);
        messages.appendChild(msgDiv);
      });
    }

    window.appendChild(header);
    window.appendChild(messages);

    if (state.messages.length === 0) {
      var suggestions = document.createElement('div');
      suggestions.className = 'mj-chatbot-suggestions';

      var suggestionsData = [
        "What's Mike's AI expertise?",
        'Tell me about Velocity Partners',
        "Mike's career highlights"
      ];

      suggestionsData.forEach(function(text) {
        var btn = document.createElement('button');
        btn.className = 'mj-chatbot-suggestion';
        btn.setAttribute('aria-label', 'Ask: ' + text);
        btn.textContent = text;
        suggestions.appendChild(btn);
      });

      window.appendChild(suggestions);
    }

    if (state.rateLimited) {
      var rateLimit = document.createElement('div');
      rateLimit.className = 'mj-chatbot-rate-limit';
      rateLimit.setAttribute('role', 'alert');
      rateLimit.textContent = 'Please wait ' + Math.ceil((state.rateLimitEnd - Date.now()) / 1000) + 's before sending another message.';
      window.appendChild(rateLimit);
    }

    var inputContainer = document.createElement('div');
    inputContainer.className = 'mj-chatbot-input-container';

    var textarea = document.createElement('textarea');
    textarea.className = 'mj-chatbot-input';
    textarea.placeholder = "Ask me about Mike's work...";
    textarea.setAttribute('aria-label', 'Type your message');
    textarea.setAttribute('autocomplete', 'off');
    textarea.rows = 1;

    var sendButton = document.createElement('button');
    sendButton.className = 'mj-chatbot-send-button';
    sendButton.setAttribute('aria-label', 'Send message');
    sendButton.textContent = state.isLoading ? 'Sending...' : 'Send';
    if (state.isLoading) {
      sendButton.disabled = true;
    }

    inputContainer.appendChild(textarea);
    inputContainer.appendChild(sendButton);
    window.appendChild(inputContainer);

    container.appendChild(window);
    return container;
  }

  function render() {
    var existing = document.querySelector('.mj-chatbot-widget');
    if (existing) {
      existing.remove();
    }

    var widget = state.isOpen ? createWindowView() : createBubbleView();
    document.body.appendChild(widget);
    attachEventListeners();

    if (state.isOpen) {
      var input = widget.querySelector('.mj-chatbot-input');
      if (input) {
        setTimeout(function() { input.focus(); }, 100);
      }

      var messages = widget.querySelector('.mj-chatbot-messages');
      if (messages) {
        messages.scrollTop = messages.scrollHeight;
      }
    }
  }

  function attachEventListeners() {
    var bubble = document.querySelector('.mj-chatbot-bubble');
    var minimize = document.querySelector('.mj-chatbot-minimize');
    var close = document.querySelector('.mj-chatbot-close');
    var sendButton = document.querySelector('.mj-chatbot-send-button');
    var input = document.querySelector('.mj-chatbot-input');
    var suggestions = document.querySelectorAll('.mj-chatbot-suggestion');

    if (bubble) {
      bubble.addEventListener('click', openChat);
    }

    if (minimize) {
      minimize.addEventListener('click', minimizeChat);
    }

    if (close) {
      close.addEventListener('click', closeChat);
    }

    if (sendButton) {
      sendButton.addEventListener('click', sendMessage);
    }

    if (input) {
      input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      input.addEventListener('input', function() {
        input.style.height = 'auto';
        input.style.height = Math.min(input.scrollHeight, 120) + 'px';
      });
    }

    suggestions.forEach(function(btn) {
      btn.addEventListener('click', function() {
        var question = btn.textContent.trim();
        state.messages.push({ role: 'user', content: question });
        render();
        callAPI(question);
      });
    });

    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && state.isOpen) {
        closeChat();
      }
    });
  }

  function openChat() {
    state.isOpen = true;
    render();
  }

  function minimizeChat() {
    state.isOpen = false;
    render();
  }

  function closeChat() {
    state.isOpen = false;
    state.messages = [];
    render();
  }

  function sendMessage() {
    var input = document.querySelector('.mj-chatbot-input');
    var message = input && input.value ? input.value.trim() : '';

    if (!message || state.isLoading || state.rateLimited) {
      return;
    }

    state.messages.push({ role: 'user', content: message });
    input.value = '';
    render();
    callAPI(message);
  }

  function callAPI(message) {
    state.isLoading = true;
    render();

    var messagesDiv = document.querySelector('.mj-chatbot-messages');
    var typingIndicator = document.createElement('div');
    typingIndicator.className = 'mj-chatbot-typing';
    typingIndicator.innerHTML = '<div class="mj-chatbot-typing-dot"></div>' +
      '<div class="mj-chatbot-typing-dot"></div>' +
      '<div class="mj-chatbot-typing-dot"></div>';

    if (messagesDiv) {
      messagesDiv.appendChild(typingIndicator);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    fetch(CONFIG.apiEndpoint, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Session-ID': state.sessionId
      },
      body: JSON.stringify({ message: message })
    })
    .then(function(response) {
      if (typingIndicator && typingIndicator.parentNode) {
        typingIndicator.remove();
      }

      if (response.status === 429) {
        return response.json().then(function(data) {
          state.rateLimited = true;
          state.rateLimitEnd = Date.now() + CONFIG.rateLimitCooldown;

          setTimeout(function() {
            state.rateLimited = false;
            render();
          }, CONFIG.rateLimitCooldown);

          render();
        });
      }

      if (!response.ok) {
        throw new Error('API request failed');
      }

      return response.json();
    })
    .then(function(data) {
      if (data) {
        state.messages.push({
          role: 'assistant',
          content: data.message || data.response || 'Sorry, I encountered an error. Please try again.'
        });
        state.isLoading = false;
        render();
      }
    })
    .catch(function(error) {
      console.error('Chat error:', error);
      if (typingIndicator && typingIndicator.parentNode) {
        typingIndicator.remove();
      }
      state.messages.push({
        role: 'assistant',
        content: 'Sorry, there was a connection error. Please try again.'
      });
      state.isLoading = false;
      render();
    });
  }

  function init() {
    injectStyles();
    render();
    console.log('[MJ Chatbot] Initialized successfully');
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>
